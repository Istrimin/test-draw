<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw</title>
    <link rel="stylesheet" href="cancer.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jscolor/2.4.5/jscolor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <script src="cancerCursors.js" defer></script>
    <style>
        #drawingCanvas {
            cursor: url('../cursorsNum/1.png'), auto;
        }

        .canvas-container {
            position: relative;
        }
    </style>
</head>

<body>
    <main class="base-container">
        <aside class="sidebar" style="z-index: 10;">
            <a href="../index.html" target="_self" title="–í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–∞–Ω—Ç—ã" id="exitLink"
                style="font-size: 50px;">üö™</a>
            <button id="undo" title="–û—Ç–º–µ–Ω–∏—Ç—å (Z)">‚ü≤</button>
            <button id="redo" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (X)">‚ü≥</button>
            <button id="symmetry" title="–°–∏–º–º–µ—Ç—Ä–∏—è (S)">ü¶ã</button>
            <button id="eyedropperBtn" title="–ü–∏–ø–µ—Ç–∫–∞ –∑–∞–ª–∏–≤–∫–∏ (A)">üíß</button>
            <button id="changeCursorBtn" title="–°–º–µ–Ω–∏—Ç—å –∫—É—Ä—Å–æ—Ä">üé®</button>
            <button id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å">üíÄ</button>
            <button id="saveImageBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üíæ</button>
            <button id="eraserBtn" title="–°—Ç–µ—Ä–∫–∞">üßΩ</button>
        </aside>
        <div class="canvas-and-sliders">
            <div class="canvas-container">
                <div class="color-picker-group">
                    <input type="color" id="colorPicker" value="#000000" title="–¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ (C)">
                    <input type="color" id="backgroundPicker" value="#ffffff" title="–¶–≤–µ—Ç —Ñ–æ–Ω–∞ (B)">
                    <button id="previousWord" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–ª–æ–≤–æ">&lt;</button>
                    <p id="Quizz"></p>
                    <button id="nextWord" title="–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ">&gt;</button>
                    <div id="elapsedTime" class="time"></div>
                </div>
                <div class="canv-container" style="position: relative; width: 700px; height: 500px;">
                    <canvas id="backgroundCanvas" width="700" height="500"
                        style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
                    <canvas id="drawingCanvas" width="700" height="500"
                        style="position: absolute; top: 0; left: 0; z-index: 3;"></canvas>
                    <canvas id="overlayCanvas" width="700" height="500"
                        style="position: absolute; top: 0; left: 0; z-index: 2; opacity: 0.5;"></canvas>
                </div>
                <div id="cursorPanel" class="cursor-panel" style="display: none;">
                    <div id="cursorList"></div>
                </div>
            </div>
<div id="chat-container">
  <div id="chat-messages"></div>
  <form id="chat-form">
    <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
</div>

    <div class="slider-group">
        <div class="slider">
            <div class="pressure-bar" id="pressureBar"></div>
            <label for="brushSize" title="–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏">üñåÔ∏è</label>
            <input type="range" id="brushSize" min="1" max="100" value="3">
            <span class="slider-value" id="rangeValue">3</span>
        </div>
    </div>
        </div>
    </main>
    <script>
const colorPicker = $('colorPicker');
const backgroundPicker = $('backgroundPicker');
const drawingCanvas = $('drawingCanvas');
const backgroundCanvas = $('backgroundCanvas');
const ctx = drawingCanvas.getContext('2d');
const bgCtx = backgroundCanvas.getContext('2d');
const symmetryButton = $('symmetry');
const brushSizeInput = $('brushSize');
const eyedropperBtn = $('eyedropperBtn');
const clearBtn = $('clearBtn');
const eraserBtn = $('eraserBtn');
const undoBtn = $('undo');
const redoBtn = $('redo');
const saveImageBtn = $('saveImageBtn');
const overlayCanvas = $('overlayCanvas');
const overlayCtx = overlayCanvas.getContext('2d');

let isDrawing = false;
let lastX = 0;
let lastY = 0;
let isEyedropperActive = false;
let symmetry = true;
let isErasing = false;
let history = [];
let redoHistory = [];
let overlayActive = false;
let currentCursor = 'url(../cursorsNum/1.png), auto';
let previousCursor = currentCursor;

ctx.imageSmoothingEnabled = false;
ctx.willReadFrequently = true;

function initializeCanvas() {
    const backgroundImage = new Image();
    backgroundImage.onload = () => {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    };
    saveState();
}

function saveState() {
    history.push(ctx.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height));
    redoHistory = [];
    updateUndoRedoButtons();
}

function updateUndoRedoButtons() {
    undoBtn.disabled = history.length <= 1;
    redoBtn.disabled = redoHistory.length === 0;
}

function startDrawing(e) {
    isDrawing = true;
    [lastX, lastY] = getCoordinates(e);
}

function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();

    const [x, y] = getCoordinates(e);
    
    const pressure = e.pressure || 1;
    ctx.lineWidth = brushSizeInput.value * pressure;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    if (isErasing) {
        ctx.globalCompositeOperation = 'destination-out';
    } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = colorPicker.value;
    }

    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();

    if (symmetry) {
        const centerX = drawingCanvas.width / 2;
        const symmetricX = 2 * centerX - x;
        ctx.beginPath();
        ctx.moveTo(2 * centerX - lastX, lastY);
        ctx.lineTo(symmetricX, y);
        ctx.stroke();
    }

    [lastX, lastY] = [x, y];
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        saveState();
    }
}

function getCoordinates(e) {
    const rect = drawingCanvas.getBoundingClientRect();
    return [
        e.clientX - rect.left,
        e.clientY - rect.top
    ];
}

function toggleSymmetry() {
    symmetry = !symmetry;
    symmetryButton.classList.toggle('active', symmetry);
}

function undo() {
    if (history.length > 1) {
        redoHistory.push(history.pop());
        ctx.putImageData(history[history.length - 1], 0, 0);
        updateUndoRedoButtons();
    }
}

function redo() {
    if (redoHistory.length > 0) {
        const state = redoHistory.pop();
        history.push(state);
        ctx.putImageData(state, 0, 0);
        updateUndoRedoButtons();
    }
}

function clearCanvas() {
    ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    saveState();
}

function saveImage() {
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = drawingCanvas.width;
    tempCanvas.height = drawingCanvas.height;
    const tempCtx = tempCanvas.getContext('2d');

    tempCtx.drawImage(drawingCanvas, 0, 0);

    if (overlayActive) {
        tempCtx.globalAlpha = parseFloat(overlayCanvas.style.opacity);
        tempCtx.drawImage(overlayCanvas, 0, 0);
        tempCtx.globalAlpha = 1.0;
    }

    const link = document.createElement('a');
    link.download = 'my-drawing.png';
    link.href = tempCanvas.toDataURL('image/png');
    link.click();
}

function resizeCanvas() {
    const rect = backgroundCanvas.getBoundingClientRect();
    backgroundCanvas.width = rect.width * devicePixelRatio;
    backgroundCanvas.height = rect.height * devicePixelRatio;
    drawingCanvas.width = rect.width * devicePixelRatio;
    drawingCanvas.height = rect.height * devicePixelRatio;
    ctx.scale(devicePixelRatio, devicePixelRatio);
    bgCtx.scale(devicePixelRatio, devicePixelRatio);
    initializeCanvas();
}

function createOverlayLayer() {
    overlayActive = true;
    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    overlayCtx.drawImage(drawingCanvas, 0, 0);
    overlayCanvas.style.opacity = '0.5';
    clearCanvas();
}

function toggleOverlayOpacity() {
    if (overlayActive) {
        overlayCanvas.style.opacity = overlayCanvas.style.opacity === '0.5' ? '1' : '0.5';
    }
}

function toggleEraser() {
    isErasing = !isErasing;
    eraserBtn.classList.toggle('active', isErasing);
    if (isErasing) {
        previousCursor = drawingCanvas.style.cursor;
        drawingCanvas.style.cursor = 'url(../cursorsNum/2.png), auto';
    } else {
        drawingCanvas.style.cursor = previousCursor;
    }
}

function toggleEyedropper() {
    isEyedropperActive = !isEyedropperActive;
    eyedropperBtn.classList.toggle('active', isEyedropperActive);
    if (isEyedropperActive) {
        previousCursor = drawingCanvas.style.cursor;
        drawingCanvas.style.cursor = 'url(../cursorsNum/3.png), auto';
        drawingCanvas.addEventListener('click', pickColor, { once: true });
    } else {
        drawingCanvas.style.cursor = previousCursor;
    }
}

function initializeCursor() {
    drawingCanvas.style.cursor = currentCursor;
}

// Event Listeners
colorPicker.addEventListener('input', () => ctx.strokeStyle = colorPicker.value);
backgroundPicker.addEventListener('input', () => {
    bgCtx.fillStyle = backgroundPicker.value;
    bgCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
});

document.addEventListener('pointerdown', (e) => {
    if (e.target === drawingCanvas) {
        startDrawing(e);
    }
});
document.addEventListener('pointermove', (e) => {
    if (isDrawing) {
        draw(e);
    }
});
document.addEventListener('pointerup', stopDrawing);
document.addEventListener('pointercancel', stopDrawing);

symmetryButton.addEventListener('click', toggleSymmetry);
undoBtn.addEventListener('click', undo);
redoBtn.addEventListener('click', redo);
clearBtn.addEventListener('click', clearCanvas);
eraserBtn.addEventListener('click', toggleEraser);
saveImageBtn.addEventListener('click', saveImage);
eyedropperBtn.addEventListener('click', toggleEyedropper);

window.addEventListener('resize', resizeCanvas);

document.addEventListener('keydown', (e) => {
    const key = e.code.toLowerCase();
    if (key === 'keyd') {
        createOverlayLayer();
    } else if (key === 'keyg') {
        toggleOverlayOpacity();
    }
});

// Initialization
initializeCanvas();
resizeCanvas();
initializeCursor();

if (window.PointerEvent) {
    console.log('Pointer events are supported');
} else {
    console.log('Pointer events are not supported');
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('a, button').forEach(icon => icon.classList.add('icon-hover'));
});

    </script>
    <script type="module" src="cancer.js" defer></script>
    <script type="module" src="cancerSettings.js" defer></script>
    <script type="module" src="cancerHelper.js" defer></script>
    <script type="module" src="cancerHotkey.js" defer></script>
</body>

</html>