<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrawCaterpillar</title>
    <link rel="stylesheet" href="cancer.css">
    <script src="cancerCursors.js" async></script>
    <style>
        #drawingCanvas {
            cursor: url('../cursorsNum/4.png'), auto;
        }

        /* –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ —Å—Ç–∏–ª—è */
        /* .canvas-container {
            position: relative;
        } */
    </style>
</head>

<body>
    <main class="base-container">
        <aside class="sidebar" style="z-index: 10;">
            <a href="../index.html" target="_self" title="–í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–∞–Ω—Ç—ã" id="exitLink" style="font-size: 50px;">üö™</a>
            <button id="undo" title="–û—Ç–º–µ–Ω–∏—Ç—å (Z)">‚ü≤</button>
            <button id="redo" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (X)">‚ü≥</button>
            <button id="symmetryBtn" title="–°–∏–º–º–µ—Ç—Ä–∏—è (S)">ü¶ã</button>
            <button id="eyedropperBtn" title="–ü–∏–ø–µ—Ç–∫–∞ –∑–∞–ª–∏–≤–∫–∏ (A)">üíß</button>
            <button id="changeCursorBtn" title="–°–º–µ–Ω–∏—Ç—å –∫—É—Ä—Å–æ—Ä">üé®</button>
            <button id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å">üíÄ</button>
            <button id="saveImageBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üíæ</button>
            <button id="eraserBtn" title="–°—Ç–µ—Ä–∫–∞">üßΩ</button>
            <button id="smoothDrawingBtn" title="–ü–∞—É—Ç–∏–Ω–∫–∞">üåÄ</button>
        </aside>

        <div class="canvas-and-sliders">
            <div class="canvas-container">
                <div class="color-picker-group">
                    <input type="color" id="colorPicker" value="#000000" title="–¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ (C)">
                    <input type="color" id="backgroundPicker" value="#ffffff" title="–¶–≤–µ—Ç —Ñ–æ–Ω–∞ (B)">
                    <button id="previousWord" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–ª–æ–≤–æ">&lt;</button>
                    <p id="Quizz"></p>
                    <button id="nextWord" title="–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ">&gt;</button>
                    <div id="elapsedTime" class="time"></div>
                </div>

                <div class="canvas-and-chat-container">
                    <div class="canvas-container">
                        <div class="canv-container" style="position: relative; width: 700px; height: 500px;">
                            <canvas id="backgroundCanvas" width="700" height="500"
                                style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
                            <canvas id="drawingCanvas" width="700" height="500"
                                style="position: absolute; top: 0; left: 0; z-index: 3;"></canvas>
                            <canvas id="overlayCanvas" width="700" height="500"
                                style="position: absolute; top: 0; left: 0; z-index: 2; opacity: 0.5;"></canvas>
                        </div>
                        <div id="cursorPanel" class="cursor-panel" style="display: none;">
                            <div id="cursorList"></div>
                        </div>
                    </div>

                    <div id="chat-container">
                        <div id="chat-messages"></div>
                        <form id="chat-form">
                            <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                            <button type="submit">=</button>
                        </form>
                    </div>
                </div>
                <div class="slider-group">
                    <div class="slider">
                        <div class="pressure-bar" id="pressureBar"></div>
                        <label for="brushSize" title="–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏">üñåÔ∏è</label>
                        <input type="range" id="brushSize" min="1" max="100" value="3">
                        <span class="slider-value" id="rangeValue">3</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        const $ = id => document.getElementById(id);

        // –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ —Å–º—ã—Å–ª—É
        const canvasElements = [
            'backgroundCanvas',
            'drawingCanvas',
            'overlayCanvas'
        ].map($);
        const [backgroundCanvas, drawingCanvas, overlayCanvas] = canvasElements;

        const inputElements = [
            'colorPicker',
            'backgroundPicker',
            'brushSize'
        ].map($);
        const [colorPicker, backgroundPicker, brushSizeInput] = inputElements;

        const buttonElements = [
            'symmetryBtn',
            'eyedropperBtn',
            'clearBtn',
            'eraserBtn',
            'undo',
            'redo',
            'saveImageBtn',
            'smoothDrawingBtn'
        ].map($);
        const [symmetryButton, eyedropperBtn, clearBtn, eraserBtn, undoBtn, redoBtn, saveImageBtn, smoothDrawingBtn] = buttonElements;

        const ctx = drawingCanvas.getContext('2d');
        const bgCtx = backgroundCanvas.getContext('2d');
        const overlayCtx = overlayCanvas.getContext('2d');

        // –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ —Å–º—ã—Å–ª—É
        let isDrawing = false;
        let isEyedropperActive = false;
        let isErasing = false;
        let symmetryBtn = true; // –í–æ–∑–º–æ–∂–Ω–æ, –æ–ø–µ—á–∞—Ç–∫–∞: symmetryBtn –≤–º–µ—Å—Ç–æ symmetry?
        let overlayActive = false;
        let isSmoothDrawing = false;

        let lastX = 0;
        let lastY = 0;
        let currentCursor = 'url(../cursorsNum/1.png), auto';
        let previousCursor = currentCursor;
        let points = [];

        let history = [];
        let redoHistory = [];

        ctx.imageSmoothingEnabled = false;
        ctx.willReadFrequently = true;

        // –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –¥–æ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        function saveState() {
            history.push(ctx.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height));
            redoHistory = [];
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            undoBtn.disabled = history.length <= 1;
            redoBtn.disabled = redoHistory.length === 0;
        }

        function resizeCanvas() {
            const rect = backgroundCanvas.getBoundingClientRect();
            backgroundCanvas.width = rect.width * devicePixelRatio;
            backgroundCanvas.height = rect.height * devicePixelRatio;
            drawingCanvas.width = rect.width * devicePixelRatio;
            drawingCanvas.height = rect.height * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            bgCtx.scale(devicePixelRatio, devicePixelRatio);
            // initializeCanvas(); // –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–∑—ã–≤–∞—Ç—å –∑–¥–µ—Å—å
        }

        function drawSmoothLine(startX, startY, endX, endY) {
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: ctx.globalAlpha —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
            ctx.globalAlpha = 1;
            ctx.strokeStyle = colorPicker.value;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.quadraticCurveTo(startX, startY, endX, endY);
            ctx.stroke();

            points.push({ x: endX, y: endY });

            for (let i = 0; i < points.length; i++) {
                const dx = points[i].x - endX;
                const dy = points[i].y - endY;
                const dd = dx * dx + dy * dy;

                if (dd < 1000) {
                    ctx.beginPath();
                    ctx.moveTo(endX + (dx * 0.2), endY + (dy * 0.2));
                    ctx.lineTo(points[i].x - (dx * 0.2), points[i].y - (dy * 0.2));
                    ctx.stroke();
                }
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getCoordinates(e);
            if (isSmoothDrawing) {
                points.push({ x: lastX, y: lastY });
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            // e.preventDefault();

            const [x, y] = getCoordinates(e);

            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: ctx.lineWidth, ctx.lineCap –∏ ctx.lineJoin —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
            ctx.lineWidth = brushSizeInput.value * (e.pressure || 1);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: ctx.globalCompositeOperation —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
            ctx.globalCompositeOperation = isErasing ? 'destination-out' : 'source-over';
            if (!isErasing) {
                ctx.strokeStyle = colorPicker.value;
            }

            if (isSmoothDrawing) {
                drawSmoothLine(lastX, lastY, x, y);
            } else {
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            if (symmetryBtn) {
                const centerX = drawingCanvas.width / 2;
                const symmetricX = 2 * centerX - x;
                if (isSmoothDrawing) {
                    drawSmoothLine(2 * centerX - lastX, lastY, symmetricX, y);
                } else {
                    ctx.beginPath();
                    ctx.moveTo(2 * centerX - lastX, lastY);
                    ctx.lineTo(symmetricX, y);
                    ctx.stroke();
                }
            }

            [lastX, lastY] = [x, y];
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveState();
                if (isSmoothDrawing) {
                    points.length = 0;
                }
            }
        }

        function getCoordinates(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            return [
                e.clientX - rect.left,
                e.clientY - rect.top
            ];
        }

        function toggleSymmetry() {
            symmetryBtn = !symmetryBtn;
            symmetryButton.classList.toggle('active', symmetryBtn);
        }

        function undo() {
            if (history.length > 1) {
                redoHistory.push(history.pop());
                ctx.putImageData(history[history.length - 1], 0, 0);
                updateUndoRedoButtons();
            }
        }

        function redo() {
            if (redoHistory.length > 0) {
                const state = redoHistory.pop();
                history.push(state);
                ctx.putImageData(state, 0, 0);
                updateUndoRedoButtons();
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            saveState();
        }

        function saveImage() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = drawingCanvas.width;
            tempCanvas.height = drawingCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            tempCtx.drawImage(drawingCanvas, 0, 0);

            if (overlayActive) {
                tempCtx.globalAlpha = parseFloat(overlayCanvas.style.opacity);
                tempCtx.drawImage(overlayCanvas, 0, 0);
                tempCtx.globalAlpha = 1.0;
            }

            const link = document.createElement('a');
            link.download = 'my-drawing.png';
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }

        function createOverlayLayer() {
            overlayActive = true;
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            overlayCtx.drawImage(drawingCanvas, 0, 0);
            overlayCanvas.style.opacity = '0.5';
            clearCanvas();
        }

        function toggleOverlayOpacity() {
            if (overlayActive) {
                overlayCanvas.style.opacity = overlayCanvas.style.opacity === '0.5' ? '1' : '0.5';
            }
        }

        function toggleEraser() {
            isErasing = !isErasing;
            eraserBtn.classList.toggle('active', isErasing);
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫—É—Ä—Å–æ—Ä —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            drawingCanvas.style.cursor = isErasing ? 'url(../cursorsNum/2.png), auto' : previousCursor;
        }

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        function toggleEyedropper() {
            isEyedropperActive = !isEyedropperActive;
            eyedropperBtn.classList.toggle('active', isEyedropperActive);
            if (isEyedropperActive) {
                previousCursor = drawingCanvas.style.cursor;
                drawingCanvas.style.cursor = 'url(../cursorsNum/3.png), auto';
                drawingCanvas.addEventListener('click', pickColor, { once: true }); // –î–æ–±–∞–≤–ª–µ–Ω–æ { once: true }
            } else {
                drawingCanvas.style.cursor = previousCursor;
                drawingCanvas.removeEventListener('click', pickColor);
            }
        }

        function pickColor(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const color = `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
            colorPicker.value = color;
            ctx.strokeStyle = color;

            // –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
            isEyedropperActive = false;
            eyedropperBtn.classList.remove('active');
            drawingCanvas.style.cursor = previousCursor;
        }

        function initializeCursor() {
            drawingCanvas.style.cursor = currentCursor;
        }

        function toggleSmoothDrawing() {
            isSmoothDrawing = !isSmoothDrawing;
            smoothDrawingBtn.classList.toggle('active', isSmoothDrawing);
        }

        // Event Listeners
        colorPicker.addEventListener('input', () => ctx.strokeStyle = colorPicker.value);
        document.addEventListener('pointerdown', startDrawing);
        document.addEventListener('pointermove', draw);
        document.addEventListener('pointerup', stopDrawing);
        document.addEventListener('pointercancel', stopDrawing);
    // drawingCanvas.addEventListener('mousedown', startDrawing);
    // drawingCanvas.addEventListener('mousemove', draw);
    // document.addEventListener('mouseup', stopDrawing);


        symmetryButton.addEventListener('click', toggleSymmetry);
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);
        clearBtn.addEventListener('click', clearCanvas);
        eraserBtn.addEventListener('click', toggleEraser);
        saveImageBtn.addEventListener('click', saveImage);
        eyedropperBtn.addEventListener('click', toggleEyedropper);
        smoothDrawingBtn.addEventListener('click', toggleSmoothDrawing);
        window.addEventListener('resize', resizeCanvas);

        // Initialization
        resizeCanvas();
        initializeCursor();

        // –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ Pointer Events
        console.log(`Pointer events are ${window.PointerEvent ? '' : 'not '}supported`);

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('a, button').forEach(icon => icon.classList.add('icon-hover'));
        });
    </script>

    <script type="module" src="cancerSettings.js" defer></script>
    <script type="module" src="cancerHelper.js" defer></script>
    <script type="module" src="cancerHotkey.js" defer></script>
</body>

</html>
