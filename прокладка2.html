<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç–æ—è—â–∏–π –•—É–¥–æ–∂–Ω–∏–∫</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jscolor/2.4.5/jscolor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <script type="module" src="tools.js" defer></script>
    <style>
        .word-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            z-index: 10;
        }
        .word-navigation button {
            margin: 0 10px;
        }
        .layer-panel {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }
        .layer-button {
            padding: 5px;
            cursor: pointer;
        }
        .active-layer {
            background-color: #ddd;
        }
.canv-container {
    position: relative; /* To contain absolutely positioned children */
    width: 700px; /* Width of the canvas */
    height: 500px; /* Height of the canvas */
}

.canv-container canvas {
    position: absolute; /* Position each canvas absolutely */
    top: 0; /* Align all canvases to the top */
    left: 0; /* Align all canvases to the left */
    z-index: 1; /* Default z-index */
}
#layer1 { z-index: 1; }
#layer2 { z-index: 2; }
#layer3 { z-index: 3; }

/* added new */

.canvas-and-sliders {
    display: flex; /* Flexbox to arrange layer panel and canvases side by side */
}

        .layer-panel {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            font-size: 12px;
            margin-right: 10px;
            max-width: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        .layer-button {
            padding: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .layer-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }


    .color-picker-group {
        display: flex;  /* —ç—Ç–æ –∑–∞—á–µ–º?*/
        /* flex-wrap: wrap;  *//* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Ö –æ–±–µ—Ä–Ω—É—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É */
        gap: 1px; /* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
    }

/* add tema */
    .color-picker-group input[type="color"] {
        appearance: none; /* –£–±–∏—Ä–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ input */
        -webkit-appearance: none; /* –£–±–∏—Ä–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ input –≤ Safari */
        border: none; /* –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫—É */
        width: 10px; /* –®–∏—Ä–∏–Ω–∞ –∫—Ä—É–≥–∞ */
        height: 10px; /* –í—ã—Å–æ—Ç–∞ –∫—Ä—É–≥–∞ */
        border-radius: 50%; /* –î–µ–ª–∞–µ–º –∫—Ä—É–≥–ª—ã–π */
        padding: 0;
        cursor: pointer;
        overflow: hidden; /* –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ –≤—ã—Ö–æ–¥—è—â–∏–µ —á–∞—Å—Ç–∏ */
    }

    .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0; /* –£–±–∏—Ä–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
    }

    .color-picker-group input[type="color"]::-webkit-color-swatch {
        border: none; /* –£–±–∏—Ä–∞–µ—Ç —Ä–∞–º–∫—É */
        border-radius: 50%; /* –ö—Ä—É–≥–ª–∞—è —Ñ–æ—Ä–º–∞ */
    }


.color-picker-and-word {
    display: flex; /* Flexbox layout */
    align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    gap: 100px; 
}

.color-picker-group {
    display: flex; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    gap: 5px; /* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
}

.word-navigation {
    /* display: flex; */
 /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    /* align-items: center; */
 /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    gap: 0px; 
/* –ü—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —Ç–µ–∫—Å—Ç–æ–º */
}
.word-navigation button {
    margin: 0; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    padding: 5px; /* –ù–µ–º–Ω–æ–≥–æ –¥–æ–±–∞–≤–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—Ç—Å—Ç—É–ø–∞ */
    cursor: pointer;
}
    </style>
</head>
<body>
    <div class="header-container">
        <div id="time" class="time"></div>
        <div id="startTime" class="time"></div>
        <div id="elapsedTime" class="time"></div>
    </div>
    <div class="base-container">
        <div class="sidebar">
            <a href="index.html" target="_self" title="–í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–∞–Ω—Ç—ã" id="exitLink">üö™</a>
            <button id="myBtn" title="–°–æ–æ–±—â–µ–Ω–∏–µ">‚úâÔ∏è</button>
            <div id="message-container" style="display: none;">
                <p id="message"></p>
            </div>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <button id="UploadButton" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (U)">üå∫</button>
            <button id="saveImageBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üé¨</button>
            <button id="changeCursorBtn" title="–°–º–µ–Ω–∏—Ç—å –∫—É—Ä—Å–æ—Ä">üé®</button>
            <button id="undo" title="–û—Ç–º–µ–Ω–∏—Ç—å (Z)">‚ü≤</button>
            <button id="redo" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (X)">‚ü≥</button>
            <button id="clear" title="–û—á–∏—Å—Ç–∏—Ç—å">üíÄ</button>
            <button id="symmetry" title="–°–∏–º–º–µ—Ç—Ä–∏—è (S)">ü¶ã</button>
            <button id="fillModeBtn" title="–ó–∞–ª–∏–≤–∫–∞ (F)">üåä</button>
            <button id="floodFillBtn" title="–ó–∞–ª–∏—Ç—å —Ü–≤–µ—Ç–æ–º">‚ú®</button>
            <button id="eyedropperBtn" title="–ü–∏–ø–µ—Ç–∫–∞ –∑–∞–ª–∏–≤–∫–∏ (A)">üíß</button>
            <button id="brushEyedropperBtn" title="–ü–∏–ø–µ—Ç–∫–∞ –∫–∏—Å—Ç–∏ (D)">üñåÔ∏è</button>
            <div id="cursorPanel" class="cursor-panel" style="display: none;">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å–æ—Ä</h3>
                <div id="cursorList"></div>
            </div>
            <button id="settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        </div>
    <div class="canvas-and-sliders">
        <div class="layer-panel">
            <div class="layer-controls">
                <button id="addLayerBtn">+</button>
                <button id="removeLayerBtn">-</button>
            </div>
            <div id="layerButtons"></div>
        </div>
        <div class="canvas-container">
<div class="color-picker-and-word">
    <div class="color-picker-group">
        <input type="color" id="colorPicker" value="#000000" title="–¶–≤–µ—Ç –∑–∞–ª–∏–≤–∫–∏ (C)">
        <input type="color" id="backgroundPicker" value="#eeaaff" title="–¶–≤–µ—Ç —Ñ–æ–Ω–∞ (B)">
        <input type="color" id="colorPicker3" value="#ff0000" title="–¶–≤–µ—Ç –∫–∏—Å—Ç–∏ 3">  
        <input type="color" id="colorPicker4" value="#ffa500" title="–¶–≤–µ—Ç –∫–∏—Å—Ç–∏ 4">
        <input type="color" id="colorPicker5" value="#ffff00" title="–¶–≤–µ—Ç –∫–∏—Å—Ç–∏ 5">    
        <input type="color" id="colorPicker6" value="#008000" title="–¶–≤–µ—Ç –∫–∏—Å—Ç–∏ 6">
        <input type="color" id="colorPicker7" value="#00ffff" title="–¶–≤–µ—Ç –∫–∏—Å—Ç–∏ 7">
        <input type="color" id="colorPicker8" value="#0000ff" title="–¶–≤–µ—Ç –∫–∏—Å—Ç–∏ 8">
        <input type="color" id="colorPicker9" value="#800080" title="–¶–≤–µ—Ç –∫–∏—Å—Ç–∏ 9">
    </div>
    <div class="word-navigation">
        <button id="previousWord" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–ª–æ–≤–æ">&lt;</button>
        <p id="Quizz"></p>
        <button id="nextWord" title="–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ">&gt;</button>
    </div>
</div>

            <div class="canv-container" id="canvasContainer">
</div>
            <div class="slider-group">
                <div class="tools-column">
                    <label for="opacity" title="–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å">üëª</label>
                    <input type="range" id="opacity" min="1" max="100" value="100">
                </div>
                <div class="tools-column">
                    <progress id="pressureBar" value="0" max="100"></progress>
                    <label for="brushSize" title="–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏">üñåÔ∏è</label>
                    <input type="range" id="brushSize" min="1" max="100" value="1">
                </div>
                <div class="color-palette" id="colorPalette">—Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞</div>
            </div>
        </div>
    </div>

            </div>
        </div>
    </div>

    <script>
    // Disable the default context menu for the entire document
    document.addEventListener('contextmenu', event => event.preventDefault());

    // Initialize layers and contexts
    const layers = {};
    const contexts = {};
    let currentLayer = 1;
    let currentCtx;
    let layerCount = 0;

    // Initialize other variables
    let isEyedropperActive = false;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let symmetry = false;

    // Get DOM elements
    const brushSizeInput = document.getElementById('brushSize');
    const opacityInput = document.getElementById('opacity');
    const pressureBar = document.getElementById('pressureBar');
    const backgroundPicker = document.getElementById('backgroundPicker');
    const canvasContainer = document.getElementById('canvasContainer');
    const layerButtons = document.getElementById('layerButtons');
    const addLayerBtn = document.getElementById('addLayerBtn');
    const removeLayerBtn = document.getElementById('removeLayerBtn');

    // Initialize pressure-supported state
    const isPressureSupported = 'onpointermove' in window;

    // History management
    let history = [];
    let redoHistory = [];
function createLayer() {
    layerCount++;
    const canvas = document.createElement('canvas');
    canvas.id = `layer${layerCount}`;
    canvas.width = 700;
    canvas.height = 500;
    canvas.style.position = 'absolute';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.zIndex = layerCount;
    canvasContainer.appendChild(canvas);

    layers[layerCount] = canvas;
    contexts[layerCount] = canvas.getContext('2d');

    const button = document.createElement('button');
    button.textContent = layerCount;
    button.classList.add('layer-button');
    button.dataset.layer = layerCount;
    layerButtons.appendChild(button);

    button.addEventListener('click', function() {
        setCurrentLayer(parseInt(this.dataset.layer));
    });

    addEventListenersToLayer(canvas);  // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –∫ –Ω–æ–≤–æ–º—É —Å–ª–æ—é
    setCurrentLayer(layerCount);
    initializeLayer(layerCount);
}

    function removeLayer() {
        if (layerCount > 1) {
            const canvas = layers[layerCount];
            canvas.remove();
            delete layers[layerCount];
            delete contexts[layerCount];

            const button = layerButtons.lastChild;
            button.remove();

            layerCount--;
            setCurrentLayer(layerCount);
        }
    }

    function setCurrentLayer(layerNum) {
        currentLayer = layerNum;
        currentCtx = contexts[currentLayer];
        document.querySelectorAll('.layer-button').forEach(btn => {
            btn.classList.remove('active-layer');
            if (parseInt(btn.dataset.layer) === currentLayer) {
                btn.classList.add('active-layer');
            }
        });
        console.log('Switched to layer:', currentLayer, 'Context:', currentCtx);
    }

    function initializeLayer(layerNum) {
        if (layerNum === 1) {
            contexts[layerNum].fillStyle = '#' + Math.floor(Math.random() * 16777215).toString(16);
        } else {
            contexts[layerNum].fillStyle = 'rgba(0,0,0,0)'; // Transparent
        }
        contexts[layerNum].fillRect(0, 0, layers[layerNum].width, layers[layerNum].height);
    }

    function clearCanvas() {
        if (!currentCtx) return;
        let clearedCanvasState = currentCtx.getImageData(0, 0, layers[currentLayer].width, layers[currentLayer].height);
        currentCtx.fillStyle = backgroundPicker.value;
        currentCtx.fillRect(0, 0, layers[currentLayer].width, layers[currentLayer].height);
        history.push(clearedCanvasState);
        redoHistory = [];
    }

    function saveState() {
        if (!currentCtx) {
            console.error('Error: currentCtx is undefined in saveState. Current layer:', currentLayer);
            return;
        }
        history.push(currentCtx.getImageData(0, 0, layers[currentLayer].width, layers[currentLayer].height));
        redoHistory = [];
        console.log('State saved for layer:', currentLayer);
    }

    function startDrawing(e) {
        if (!currentCtx) {
            console.error('Error: currentCtx is undefined in startDrawing. Current layer:', currentLayer);
            return;
        }
        isDrawing = true;
        const rect = layers[currentLayer].getBoundingClientRect();
        [lastX, lastY] = [e.clientX - rect.left, e.clientY - rect.top];
    }

    function draw(e) {
        if (!isDrawing || !currentCtx) {
            if (!currentCtx) {
                console.error('Error: currentCtx is undefined in draw. Current layer:', currentLayer);
            }
            return;
        }

        e.preventDefault();
        const rect = layers[currentLayer].getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const pressure = e.pressure || 1;

        currentCtx.lineWidth = brushSizeInput.value * pressure;
        currentCtx.lineCap = 'round';
        currentCtx.lineJoin = 'round';
        currentCtx.globalAlpha = opacityInput.value / 100;

        currentCtx.beginPath();
        currentCtx.moveTo(lastX, lastY);
        currentCtx.lineTo(x, y);
        currentCtx.stroke();

        if (symmetry) {
            const centerX = layers[currentLayer].width / 2;
            const symmetricLastX = centerX + (centerX - lastX);
            const symmetricX = centerX + (centerX - x);
            currentCtx.beginPath();
            currentCtx.moveTo(symmetricLastX, lastY);
            currentCtx.lineTo(symmetricX, y);
            currentCtx.stroke();
        }

        [lastX, lastY] = [x, y];

        if (isPressureSupported) {
            pressureBar.value = pressure * 100;
        }
    }

    function stopDrawing() {
        if (isDrawing) {
            isDrawing = false;
            saveState();
        }
    }

    function setDrawingColor(color) {
        if (currentCtx) {
            currentCtx.strokeStyle = color;
        }
    }

    // Event Listeners
    addLayerBtn.addEventListener('click', createLayer);
    removeLayerBtn.addEventListener('click', removeLayer);

    const eyedropperBtn = document.getElementById('eyedropperBtn');
    eyedropperBtn.addEventListener('click', () => {
        isEyedropperActive = !isEyedropperActive;
        if (isEyedropperActive) {
            layers[currentLayer].classList.add('pipetteCursor');
        } else {
            layers[currentLayer].classList.remove('pipetteCursor');
        }
    });

    const colorPickers = document.querySelectorAll('input[type="color"]');
    colorPickers.forEach(picker => {
        picker.addEventListener('input', (event) => {
            setDrawingColor(event.target.value);
        });
    });

    document.addEventListener('touchstart', function(e) {
        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
        }
    }, { passive: false });

    function addEventListenersToLayer(layer) {
        layer.addEventListener('pointerdown', startDrawing);
        layer.addEventListener('pointermove', draw);
        layer.addEventListener('pointerup', stopDrawing);
        layer.addEventListener('pointerout', stopDrawing);
        layer.addEventListener('pointercancel', stopDrawing);
    }

    document.querySelectorAll('button, input').forEach(element => {
        element.addEventListener('pointerdown', (e) => {
            e.stopPropagation();
        });
    });

    function resizeCanvas() {
        const rect = canvasContainer.getBoundingClientRect();
        Object.values(layers).forEach(layer => {
            layer.width = rect.width * devicePixelRatio;
            layer.height = rect.height * devicePixelRatio;
            layer.getContext('2d').scale(devicePixelRatio, devicePixelRatio);
        });
        Object.keys(layers).forEach(layerNum => initializeLayer(parseInt(layerNum)));
    }

    window.addEventListener('resize', resizeCanvas);

    // Initialize the first layer
    createLayer();
    setDrawingColor(document.getElementById('colorPicker').value);
    resizeCanvas();


// –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å–ª–æ—è–º
Object.values(layers).forEach(addEventListenersToLayer);
    </script>
    <script src="cursors.js" defer></script>
    <script src="script.js" defer></script>
    <script type="module" src="hotkey.js" defer></script>
    <script type="module" src="test.js" defer></script>
    <script type="module" src="settings.js" defer></script>
    <script type="module" src="helperFunction.js" defer></script>
</body>
</html>
